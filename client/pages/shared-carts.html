<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Carts - ShareCart</title>
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="../js/navbar.js"></script>
    <script src="../js/cart-sharing.js"></script>
    <style>
        .page-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 32px;
            border-radius: 16px;
            margin-bottom: 32px;
            text-align: center;
        }

        .page-header h1 {
            margin: 0 0 8px 0;
            font-size: 32px;
        }

        .page-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 16px;
        }

        .cart-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 24px;
            transition: all 0.3s;
        }

        .cart-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }

        .user-details h3 {
            margin: 0 0 4px 0;
            font-size: 18px;
        }

        .user-details p {
            margin: 0;
            color: var(--gray);
            font-size: 14px;
        }

        .distance-badge {
            background: #e0e7ff;
            color: #3730a3;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .cart-progress {
            margin: 20px 0;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .progress-bar {
            height: 10px;
            background: #e5e7eb;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
            transition: width 0.3s;
        }

        .cart-items-preview {
            margin: 20px 0;
        }

        .items-count {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .cart-footer {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn-add-items {
            flex: 2;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-add-items:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h2 {
            margin: 0 0 12px 0;
        }

        .empty-state p {
            margin: 0 0 24px 0;
        }

        .my-shared-cart {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .my-shared-cart .cart-header {
            border-bottom-color: rgba(255,255,255,0.3);
        }

        .my-shared-cart .distance-badge {
            background: rgba(255,255,255,0.3);
            color: white;
        }

        .my-shared-cart .items-count {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .my-shared-cart .progress-bar {
            background: rgba(255,255,255,0.3);
        }

        .my-shared-cart .progress-fill {
            background: rgba(255,255,255,0.8);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->


    <div class="container">
        <div class="page-header">
            <h1><i class="fas fa-users"></i> Shared Carts</h1>
            <p>Help nearby users complete their orders and save together!</p>
        </div>

        <div id="sharedCartsContainer">
            <!-- Shared carts will be loaded here -->
        </div>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script>
        let myLocation = null;
        let mySharedCart = null;

        // Toast notification function
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        async function init() {
            // Get user location first (critical for cart creation)
            try {
                const userData = await api.getMe();
                myLocation = userData.data.location;
                console.log('User location loaded:', myLocation);
            } catch (error) {
                console.error('Error getting user data:', error);
                // Provide default location if API fails
                myLocation = {
                    type: 'Point',
                    coordinates: [72.8777, 19.0760],
                    address: 'Not specified',
                    city: 'Mumbai',
                    pincode: '400001'
                };
            }

            // Check if user is sharing their cart (after location is loaded)
            const urlParams = new URLSearchParams(window.location.search);
            const myCart = localStorage.getItem('myShoppingCart');
            
            if (urlParams.get('action') === 'share' && myCart) {
                await shareMyCart(JSON.parse(myCart));
            }

            loadSharedCarts();
        }

        async function shareMyCart(cartItems) {
            const total = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const remaining = 250 - total;

            // Validate inputs
            if (!cartItems || cartItems.length === 0) {
                showToast('Your cart is empty! Add items first.', 'error');
                return;
            }

            if (!myLocation) {
                showToast('Unable to get your location. Please try again.', 'error');
                return;
            }

            try {
                // Prepare cart data for API
                const cartData = {
                    platform: 'blinkit', // Default platform, can be made dynamic
                    location: {
                        type: myLocation.type || 'Point',
                        coordinates: myLocation.coordinates || [72.8777, 19.0760],
                        address: myLocation.address || 'Not specified',
                        city: myLocation.city || 'Mumbai',
                        pincode: myLocation.pincode || '400001'
                    },
                    deliveryCharge: 50, // Default delivery charge
                    maxMembers: 4,
                    items: cartItems.map(item => ({
                        name: item.name,
                        quantity: item.quantity,
                        price: item.price,
                        image: item.image || '',
                        category: item.category || ''
                    })),
                    notes: `Cart total: â‚¹${total}. Need â‚¹${remaining} more to reach minimum.`,
                    isPublic: true,
                    maxDistance: 5
                };

                console.log('Creating cart with data:', cartData);

                // Save cart to database via API
                showToast('Creating shared cart...', 'info');
                const response = await api.createCart(cartData);
                console.log('Cart created successfully:', response);

                if (!response.success) {
                    throw new Error(response.message || 'Failed to create cart');
                }

                // Store the created cart
                mySharedCart = {
                    ...response.data,
                    id: response.data._id,
                    user: {
                        name: 'You',
                        location: myLocation
                    },
                    items: cartItems,
                    currentTotal: total,
                    remaining: remaining,
                    distance: 0,
                    isMyCart: true
                };

                showToast('Your cart is now shared! Others nearby can join.', 'success');
                
                // Clear the localStorage cart after successful sharing
                localStorage.removeItem('myShoppingCart');
                
                loadSharedCarts();
            } catch (error) {
                console.error('Error sharing cart:', error);
                const errorMsg = error.response?.data?.message || error.message || 'Failed to share cart';
                showToast(errorMsg, 'error');
            }
        }

        async function loadSharedCarts() {
            const container = document.getElementById('sharedCartsContainer');
            
            // Show loading state
            container.innerHTML = `
                <div class="loading-state">
                    <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: var(--primary);"></i>
                    <p style="margin-top: 20px; color: var(--gray);">Loading shared carts...</p>
                </div>
            `;
            
            let allCarts = [];
            
            try {
                // Fetch real carts from backend API
                const response = await api.getCarts();
                console.log('Shared carts response:', response);
                let sharedCarts = response.data || [];
                
                // Add mySharedCart if it exists
                allCarts = [...sharedCarts];
                if (mySharedCart) {
                    allCarts.unshift(mySharedCart);
                }
                
                // Calculate cart totals and format data
                allCarts = allCarts.map(cart => {
                    const itemsTotal = (cart.items || []).reduce((sum, item) => 
                        sum + (item.price * item.quantity), 0);
                    const remaining = 250 - itemsTotal; // Assuming 250 is minimum order
                    
                    return {
                        ...cart,
                        id: cart._id,
                        user: cart.creator || { name: 'Unknown', location: cart.location || {} },
                        items: cart.items || [],
                        currentTotal: itemsTotal,
                        remaining: remaining > 0 ? remaining : 0,
                        distance: cart.distance || 0
                    };
                });
            } catch (error) {
                console.error('Error loading shared carts:', error);
                // If API fails, show only mySharedCart if available
                if (mySharedCart) {
                    allCarts = [mySharedCart];
                }
            }
            
            // Render the carts
            if (allCarts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-shopping-cart"></i>
                        <h2>No Shared Carts Nearby</h2>
                        <p>Be the first to share your cart and let others join!</p>
                        <button class="btn btn-primary" onclick="window.location.href='shop.html'">
                            <i class="fas fa-store"></i> Start Shopping
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = allCarts.map(cart => {
                const percentage = (cart.currentTotal / 250) * 100;
                const itemCount = cart.items.reduce((sum, item) => sum + item.quantity, 0);
                const isMyCart = cart.isMyCart;

                return `
                    <div class="cart-card ${isMyCart ? 'my-shared-cart' : ''}">
                        <div class="cart-header">
                            <div class="user-info">
                                <div class="user-avatar">
                                    ${isMyCart ? 'ðŸ‘¤' : cart.user.name.charAt(0)}
                                </div>
                                <div class="user-details">
                                    <h3>${cart.user.name}${isMyCart ? ' (Your Cart)' : ''}</h3>
                                    <p><i class="fas fa-map-marker-alt"></i> ${cart.user.location.area || cart.user.location.city}</p>
                                </div>
                            </div>
                            <div class="distance-badge">
                                <i class="fas fa-location-arrow"></i> ${cart.distance} km
                            </div>
                        </div>

                        <div class="cart-progress">
                            <div class="progress-info">
                                <span>Current: â‚¹${cart.currentTotal}</span>
                                <span>Need: â‚¹${cart.remaining} more</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%"></div>
                            </div>
                        </div>

                        <div class="cart-items-preview">
                            <div class="items-count">
                                <i class="fas fa-shopping-basket"></i>
                                <span>${itemCount} items â€¢ ${cart.items.length} unique products</span>
                            </div>
                            <div style="margin-top: 12px; padding-left: 12px;">
                                ${cart.items.slice(0, 3).map(item => 
                                    `<div style="font-size: 14px; color: ${isMyCart ? 'rgba(255,255,255,0.9)' : 'var(--gray)'}; margin: 4px 0;">
                                        â€¢ ${item.name} Ã— ${item.quantity}
                                    </div>`
                                ).join('')}
                                ${cart.items.length > 3 ? `<div style="font-size: 14px; color: ${isMyCart ? 'rgba(255,255,255,0.7)' : 'var(--gray)'}; margin: 4px 0;">+ ${cart.items.length - 3} more items</div>` : ''}
                            </div>
                        </div>

                        ${isMyCart ? `
                            <div class="cart-footer">
                                <button class="btn btn-outline btn-full" style="color: white; border-color: white;" onclick="stopSharing()">
                                    <i class="fas fa-times"></i> Stop Sharing
                                </button>
                            </div>
                        ` : `
                            <div class="cart-footer">
                                <button class="btn-add-items" onclick="addToSharedCart('${cart._id || cart.id}')">
                                    <i class="fas fa-plus-circle"></i> Add My Items & Complete Order
                                </button>
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        async function addToSharedCart(cartId) {
            // Confirm joining the cart
            if (!confirm('Join this shared cart? You can add your items to help complete the order and split delivery charges.')) {
                return;
            }

            try {
                showToast('Joining cart...', 'info');
                
                // Call the real API to join the cart
                const response = await api.joinCart(cartId);
                console.log('Joined cart:', response);
                
                if (response.success) {
                    showToast('Successfully joined the cart!', 'success');
                    
                    // Redirect to shop page to add items
                    setTimeout(() => {
                        window.location.href = `shop.html?joinedCart=${cartId}`;
                    }, 1000);
                } else {
                    throw new Error(response.message || 'Failed to join cart');
                }
            } catch (error) {
                console.error('Error joining cart:', error);
                const errorMsg = error.response?.data?.message || error.message || 'Failed to join cart';
                showToast(errorMsg, 'error');
            }
        }

        function stopSharing() {
            if (confirm('Stop sharing your cart? You can share it again later.')) {
                localStorage.removeItem('myShoppingCart');
                mySharedCart = null;
                showToast('Cart sharing stopped', 'info');
                loadSharedCarts();
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('myShoppingCart');
            window.location.href = '../index.html';
        }

        // Initialize
        init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Carts - ShareCart</title>
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="../js/navbar.js"></script>
    <script src="../js/cart-sharing.js"></script>
    <style>
        .page-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 32px;
            border-radius: 16px;
            margin-bottom: 32px;
            text-align: center;
        }

        .page-header h1 {
            margin: 0 0 8px 0;
            font-size: 32px;
        }

        .page-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 16px;
        }

        .cart-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 24px;
            transition: all 0.3s;
            position: relative;
        }

        .cart-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }

        .user-details h3 {
            margin: 0 0 4px 0;
            font-size: 18px;
        }

        .user-details p {
            margin: 0;
            color: var(--gray);
            font-size: 14px;
        }

        .distance-badge {
            background: #e0e7ff;
            color: #3730a3;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .cart-progress {
            margin: 20px 0;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .progress-bar {
            height: 10px;
            background: #e5e7eb;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
            transition: width 0.3s;
        }

        .cart-items-preview {
            margin: 20px 0;
        }

        .items-count {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .cart-footer {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn-add-items {
            flex: 2;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-add-items:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h2 {
            margin: 0 0 12px 0;
        }

        .empty-state p {
            margin: 0 0 24px 0;
        }

        .my-shared-cart {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .my-shared-cart .cart-header {
            border-bottom-color: rgba(255,255,255,0.3);
        }

        .my-shared-cart .distance-badge {
            background: rgba(255,255,255,0.3);
            color: white;
        }

        .my-shared-cart .items-count {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .my-shared-cart .progress-bar {
            background: rgba(255,255,255,0.3);
        }

        .my-shared-cart .progress-fill {
            background: rgba(255,255,255,0.8);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Filters Section */
        .filters-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .filters-header h3 {
            margin: 0;
            font-size: 18px;
            color: var(--dark);
        }

        .filter-toggle {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-size: 14px;
            font-weight: 500;
            color: var(--dark);
        }

        .filter-group select,
        .filter-group input {
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .filter-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn-filter {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-apply {
            background: var(--primary);
            color: white;
        }

        .btn-apply:hover {
            background: #059669;
        }

        .btn-reset {
            background: var(--border);
            color: var(--dark);
        }

        .btn-reset:hover {
            background: #d1d5db;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-top: 32px;
            padding: 24px 0;
        }

        .pagination-btn {
            padding: 10px 16px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            padding: 10px 20px;
            background: var(--light-bg);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .page-number {
            padding: 10px 16px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }

        .page-number.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .page-number:hover:not(.active) {
            background: var(--light-bg);
        }

        .results-info {
            text-align: center;
            margin-bottom: 16px;
            color: var(--gray);
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->


    <div class="container">
        <div class="page-header">
            <h1><i class="fas fa-users"></i> Shared Carts</h1>
            <p>Help nearby users complete their orders and save together!</p>
        </div>

        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filters-header">
                <h3><i class="fas fa-filter"></i> Filters</h3>
                <button class="filter-toggle" onclick="toggleFilters()">
                    <i class="fas fa-chevron-down" id="filterIcon"></i>
                    <span id="filterText">Show Filters</span>
                </button>
            </div>
            <div id="filtersContent" style="display: none;">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label for="platformFilter">Platform</label>
                        <select id="platformFilter">
                            <option value="all">All Platforms</option>
                            <option value="blinkit">Blinkit</option>
                            <option value="zepto">Zepto</option>
                            <option value="swiggy">Swiggy Instamart</option>
                            <option value="bigbasket">BigBasket</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="sortByFilter">Sort By</label>
                        <select id="sortByFilter">
                            <option value="newest" selected>Newest First</option>
                            <option value="distance">Nearest First</option>
                            <option value="members">Most Members</option>
                            <option value="items">Most Items</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="distanceFilter">Max Distance (km)</label>
                        <input type="number" id="distanceFilter" min="0.5" max="10" step="0.5" placeholder="e.g., 2">
                    </div>
                    <div class="filter-group">
                        <label for="limitFilter">Items Per Page</label>
                        <select id="limitFilter">
                            <option value="5">5 per page</option>
                            <option value="10" selected>10 per page</option>
                            <option value="20">20 per page</option>
                            <option value="50">50 per page</option>
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="btn-filter btn-reset" onclick="resetFilters()">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                    <button class="btn-filter btn-apply" onclick="applyFilters()">
                        <i class="fas fa-check"></i> Apply Filters
                    </button>
                </div>
            </div>
        </div>

        <div class="results-info" id="resultsInfo"></div>

        <div id="sharedCartsContainer">
            <!-- Shared carts will be loaded here -->
        </div>

        <!-- Pagination -->
        <div id="paginationContainer"></div>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script>
        let myLocation = null;
        let mySharedCart = null;
        let currentPage = 1;
        let currentFilters = {
            platform: 'all',
            sortBy: 'newest',
            maxDistance: '',
            limit: 10
        };
        let totalPages = 1;
        let totalCarts = 0;

        // Toast notification function
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Toggle filters visibility
        function toggleFilters() {
            const content = document.getElementById('filtersContent');
            const icon = document.getElementById('filterIcon');
            const text = document.getElementById('filterText');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
                text.textContent = 'Hide Filters';
            } else {
                content.style.display = 'none';
                icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
                text.textContent = 'Show Filters';
            }
        }

        // Apply filters
        function applyFilters() {
            currentFilters = {
                platform: document.getElementById('platformFilter').value,
                sortBy: document.getElementById('sortByFilter').value,
                maxDistance: document.getElementById('distanceFilter').value,
                limit: parseInt(document.getElementById('limitFilter').value)
            };
            currentPage = 1; // Reset to first page
            loadSharedCarts();
            showToast('Filters applied successfully', 'success');
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('platformFilter').value = 'all';
            document.getElementById('sortByFilter').value = 'newest';
            document.getElementById('distanceFilter').value = '';
            document.getElementById('limitFilter').value = '10';
            applyFilters();
            showToast('Filters reset', 'info');
        }

        // Change page
        function changePage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            loadSharedCarts();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Render pagination
        function renderPagination() {
            const container = document.getElementById('paginationContainer');
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let paginationHTML = '<div class="pagination">';
            
            // Previous button
            paginationHTML += `
                <button class="pagination-btn" onclick="changePage(${currentPage - 1})" 
                    ${currentPage === 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
            `;

            // Page numbers (show max 5 pages)
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, startPage + 4);

            if (startPage > 1) {
                paginationHTML += `<button class="page-number" onclick="changePage(1)">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span style="padding: 10px;">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button class="page-number ${i === currentPage ? 'active' : ''}" 
                        onclick="changePage(${i})">${i}</button>
                `;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span style="padding: 10px;">...</span>`;
                }
                paginationHTML += `<button class="page-number" onclick="changePage(${totalPages})">${totalPages}</button>`;
            }

            // Next button
            paginationHTML += `
                <button class="pagination-btn" onclick="changePage(${currentPage + 1})" 
                    ${currentPage === totalPages ? 'disabled' : ''}>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            `;

            paginationHTML += '</div>';
            container.innerHTML = paginationHTML;
        }

        // Update results info
        function updateResultsInfo(count, total) {
            const info = document.getElementById('resultsInfo');
            const start = (currentPage - 1) * currentFilters.limit + 1;
            const end = Math.min(currentPage * currentFilters.limit, total);
            
            if (total === 0) {
                info.innerHTML = '<strong>No carts found</strong>';
            } else {
                info.innerHTML = `Showing <strong>${start}-${end}</strong> of <strong>${total}</strong> carts`;
            }
        }

        async function init() {
            // Get user location first (critical for cart creation)
            try {
                const userData = await api.getMe();
                myLocation = userData.data.location;
                console.log('User location loaded:', myLocation);
                
                // Validate location
                if (!myLocation || !myLocation.coordinates || 
                    myLocation.coordinates[0] === 0 || myLocation.coordinates[1] === 0) {
                    console.warn('User location not set, using default (Bangalore)');
                    myLocation = {
                        type: 'Point',
                        coordinates: [77.5946, 12.9716],
                        address: 'Bangalore',
                        city: 'Bangalore',
                        pincode: '560001'
                    };
                }
            } catch (error) {
                console.error('Error getting user data:', error);
                // Provide default location if API fails
                myLocation = {
                    type: 'Point',
                    coordinates: [77.5946, 12.9716],
                    address: 'Bangalore',
                    city: 'Bangalore',
                    pincode: '560001'
                };
            }

            // Check if user is sharing their cart (after location is loaded)
            const urlParams = new URLSearchParams(window.location.search);
            const myCart = localStorage.getItem('myShoppingCart');
            
            if (urlParams.get('action') === 'share' && myCart) {
                await shareMyCart(JSON.parse(myCart));
            }

            loadSharedCarts();
        }

        // Generate demo carts for display when no real carts exist
        function generateDemoCarts() {
            const demoUsers = [
                { name: 'Priya Sharma', area: 'Koramangala', city: 'Bangalore' },
                { name: 'Rahul Verma', area: 'Indiranagar', city: 'Bangalore' },
                { name: 'Sneha Patel', area: 'Whitefield', city: 'Bangalore' },
                { name: 'Amit Kumar', area: 'HSR Layout', city: 'Bangalore' },
                { name: 'Ananya Singh', area: 'Jayanagar', city: 'Bangalore' }
            ];

            const demoItems = [
                { name: 'Milk (1L)', quantity: 2, price: 30, category: 'Dairy' },
                { name: 'Bread', quantity: 1, price: 25, category: 'Bakery' },
                { name: 'Eggs (12)', quantity: 1, price: 80, category: 'Dairy' },
                { name: 'Tomatoes (500g)', quantity: 1, price: 35, category: 'Vegetables' },
                { name: 'Onions (1kg)', quantity: 1, price: 40, category: 'Vegetables' },
                { name: 'Rice (5kg)', quantity: 1, price: 300, category: 'Groceries' },
                { name: 'Atta (5kg)', quantity: 1, price: 250, category: 'Groceries' },
                { name: 'Dal (1kg)', quantity: 1, price: 120, category: 'Groceries' }
            ];

            const platforms = ['blinkit', 'zepto', 'swiggy', 'bigbasket'];

            return demoUsers.map((user, index) => {
                const itemCount = Math.floor(Math.random() * 4) + 2; // 2-5 items
                const selectedItems = [];
                const usedIndices = new Set();
                
                for (let i = 0; i < itemCount; i++) {
                    let randomIndex;
                    do {
                        randomIndex = Math.floor(Math.random() * demoItems.length);
                    } while (usedIndices.has(randomIndex));
                    usedIndices.add(randomIndex);
                    selectedItems.push({ ...demoItems[randomIndex] });
                }

                const itemsTotal = selectedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const remaining = 250 - itemsTotal;

                return {
                    _id: `demo-${index}`,
                    id: `demo-${index}`,
                    platform: platforms[index % platforms.length],
                    items: selectedItems,
                    currentTotal: itemsTotal,
                    remaining: remaining > 0 ? remaining : 0,
                    distance: (Math.random() * 2 + 0.5).toFixed(1),
                    user: {
                        name: user.name,
                        location: {
                            area: user.area,
                            city: user.city
                        }
                    },
                    members: [{ user: { name: user.name } }],
                    maxMembers: 4,
                    deliveryCharge: 50,
                    isDemo: true
                };
            });
        }

        async function shareMyCart(cartItems) {
            const total = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const remaining = 250 - total;

            // Validate inputs
            if (!cartItems || cartItems.length === 0) {
                showToast('Your cart is empty! Add items first.', 'error');
                return;
            }

            if (!myLocation) {
                showToast('Unable to get your location. Please try again.', 'error');
                return;
            }

            try {
                // Prepare cart data for API
                const cartData = {
                    platform: 'blinkit', // Default platform, can be made dynamic
                    location: {
                        type: myLocation.type || 'Point',
                        coordinates: myLocation.coordinates || [72.8777, 19.0760],
                        address: myLocation.address || 'Not specified',
                        city: myLocation.city || 'Mumbai',
                        pincode: myLocation.pincode || '400001'
                    },
                    deliveryCharge: 50, // Default delivery charge
                    maxMembers: 4,
                    items: cartItems.map(item => ({
                        name: item.name,
                        quantity: item.quantity,
                        price: item.price,
                        image: item.image || '',
                        category: item.category || ''
                    })),
                    notes: `Cart total: â‚¹${total}. Need â‚¹${remaining} more to reach minimum.`,
                    isPublic: true,
                    maxDistance: 5
                };

                console.log('Creating cart with data:', cartData);

                // Save cart to database via API
                showToast('Creating shared cart...', 'info');
                const response = await api.createCart(cartData);
                console.log('Cart created successfully:', response);

                if (!response.success) {
                    throw new Error(response.message || 'Failed to create cart');
                }

                // Store the created cart
                mySharedCart = {
                    ...response.data,
                    id: response.data._id,
                    user: {
                        name: 'You',
                        location: myLocation
                    },
                    items: cartItems,
                    currentTotal: total,
                    remaining: remaining,
                    distance: 0,
                    isMyCart: true
                };

                showToast('Your cart is now shared! Others nearby can join.', 'success');
                
                // Clear the localStorage cart after successful sharing
                localStorage.removeItem('myShoppingCart');
                
                // Reload carts to show the newly created cart
                await loadSharedCarts();
            } catch (error) {
                console.error('Error sharing cart:', error);
                const errorMsg = error.response?.data?.message || error.message || 'Failed to share cart';
                showToast(errorMsg, 'error');
            }
        }

        async function loadSharedCarts() {
            const container = document.getElementById('sharedCartsContainer');
            
            // Show loading state
            container.innerHTML = `
                <div class="loading-state">
                    <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: var(--primary);"></i>
                    <p style="margin-top: 20px; color: var(--gray);">Loading shared carts...</p>
                </div>
            `;
            
            try {
                // Build query params
                const params = new URLSearchParams({
                    page: currentPage,
                    limit: currentFilters.limit,
                    sortBy: currentFilters.sortBy
                });

                if (currentFilters.platform !== 'all') {
                    params.append('platform', currentFilters.platform);
                }

                if (currentFilters.maxDistance) {
                    params.append('maxDistance', currentFilters.maxDistance);
                }

                // Fetch carts with pagination
                const response = await fetch(`${API_URL}/carts?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch carts');
                }

                const data = await response.json();
                console.log('Paginated carts response:', data);

                let allCarts = data.data || [];
                totalPages = data.totalPages || 1;
                totalCarts = data.total || 0;

                // Also fetch user's own carts (only on first page)
                if (currentPage === 1) {
                    try {
                        const myCartsResponse = await api.getMyCarts();
                        console.log('My carts response:', myCartsResponse);
                        const myCarts = myCartsResponse.data || [];
                        
                        // Mark user's carts as "isMyCart"
                        const myCartsMarked = myCarts.map(cart => ({
                            ...cart,
                            isMyCart: true
                        }));
                        
                        // Add to total
                        totalCarts += myCarts.length;
                        
                        // Combine: my carts first, then other carts
                        allCarts = [...myCartsMarked, ...allCarts];
                    } catch (myCartsError) {
                        console.error('Error loading my carts:', myCartsError);
                    }
                }
                
                // Calculate cart totals and format data
                allCarts = allCarts.map(cart => {
                    const itemsTotal = (cart.items || []).reduce((sum, item) => 
                        sum + (item.price * item.quantity), 0);
                    const remaining = 250 - itemsTotal;
                    
                    // Safely extract user info with proper fallbacks
                    const creator = cart.creator || {};
                    const location = creator.location || cart.location || {};
                    
                    return {
                        ...cart,
                        id: cart._id,
                        user: {
                            name: creator.name || 'Unknown User',
                            location: {
                                area: location.area || location.city || 'Location not set',
                                city: location.city || 'Unknown City'
                            }
                        },
                        items: cart.items || [],
                        currentTotal: itemsTotal,
                        remaining: remaining > 0 ? remaining : 0,
                        distance: cart.distance || 0
                    };
                });

                // Update results info
                updateResultsInfo(allCarts.length, totalCarts);

                // If no carts found, show demo carts
                if (allCarts.length === 0) {
                    allCarts = generateDemoCarts();
                    totalCarts = allCarts.length;
                    updateResultsInfo(allCarts.length, totalCarts);
                    showToast('Showing demo carts. Share your cart to see real ones!', 'info');
                }

                container.innerHTML = allCarts.map(cart => {
                    const percentage = (cart.currentTotal / 250) * 100;
                    const itemCount = cart.items.reduce((sum, item) => sum + item.quantity, 0);
                    const isMyCart = cart.isMyCart;

                    return `
                        <div class="cart-card ${isMyCart ? 'my-shared-cart' : ''}${cart.isDemo ? ' demo-cart' : ''}">
                            ${cart.isDemo ? '<div style="position: absolute; top: 10px; left: 10px; background: #f59e0b; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">ðŸ“‹ DEMO</div>' : ''}
                            <div class="cart-header">
                                <div class="user-info">
                                    <div class="user-avatar">
                                        ${isMyCart ? 'ðŸ‘¤' : (cart.user?.name || 'U').charAt(0)}
                                    </div>
                                    <div class="user-details">
                                        <h3>${cart.user?.name || 'Unknown User'}${isMyCart ? ' (Your Cart)' : ''}</h3>
                                        <p><i class="fas fa-map-marker-alt"></i> ${cart.user?.location?.area || 'Location not set'}</p>
                                    </div>
                                </div>
                                <div class="distance-badge">
                                    <i class="fas fa-location-arrow"></i> ${cart.distance || 0} km
                                </div>
                            </div>

                            <div class="cart-progress">
                                <div class="progress-info">
                                    <span>Current: â‚¹${cart.currentTotal}</span>
                                    <span>Need: â‚¹${cart.remaining} more</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${percentage}%"></div>
                                </div>
                            </div>

                            <div class="cart-items-preview">
                                <div class="items-count">
                                    <i class="fas fa-shopping-basket"></i>
                                    <span>${itemCount} items â€¢ ${cart.items.length} unique products</span>
                                </div>
                                <div style="margin-top: 12px; padding-left: 12px;">
                                    ${cart.items.slice(0, 3).map(item => 
                                        `<div style="font-size: 14px; color: ${isMyCart ? 'rgba(255,255,255,0.9)' : 'var(--gray)'}; margin: 4px 0;">
                                            â€¢ ${item.name} Ã— ${item.quantity}
                                        </div>`
                                    ).join('')}
                                    ${cart.items.length > 3 ? `<div style="font-size: 14px; color: ${isMyCart ? 'rgba(255,255,255,0.7)' : 'var(--gray)'}; margin: 4px 0;">+ ${cart.items.length - 3} more items</div>` : ''}
                                </div>
                            </div>

                            ${isMyCart ? `
                                <div class="cart-footer">
                                    <button class="btn btn-outline btn-full" style="color: white; border-color: white;" onclick="stopSharing()">
                                        <i class="fas fa-times"></i> Stop Sharing
                                    </button>
                                </div>
                            ` : `
                                <div class="cart-footer">
                                    <button class="btn-add-items" onclick="addToSharedCart('${cart._id || cart.id}')">
                                        <i class="fas fa-plus-circle"></i> Add My Items & Complete Order
                                    </button>
                                </div>
                            `}
                        </div>
                    `;
                }).join('');

                // Render pagination
                renderPagination();

            } catch (error) {
                console.error('Error loading shared carts:', error);
                showToast('Failed to load carts. Please try again.', 'error');
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <h2>Error Loading Carts</h2>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="loadSharedCarts()">
                            <i class="fas fa-redo"></i> Try Again
                        </button>
                    </div>
                `;
                document.getElementById('paginationContainer').innerHTML = '';
            }
        }

        async function addToSharedCart(cartId) {
            // Check if it's a demo cart
            if (cartId && cartId.toString().startsWith('demo-')) {
                showToast('This is a demo cart. Share your own cart to join real carts!', 'info');
                setTimeout(() => {
                    window.location.href = 'shop.html';
                }, 2000);
                return;
            }

            // Confirm joining the cart
            if (!confirm('Join this shared cart? You can add your items to help complete the order and split delivery charges.')) {
                return;
            }

            try {
                showToast('Joining cart...', 'info');
                
                // Call the real API to join the cart
                const response = await api.joinCart(cartId);
                console.log('Joined cart:', response);
                
                if (response.success) {
                    showToast('Successfully joined the cart!', 'success');
                    
                    // Redirect to shop page to add items
                    setTimeout(() => {
                        window.location.href = `shop.html?joinedCart=${cartId}`;
                    }, 1000);
                } else {
                    throw new Error(response.message || 'Failed to join cart');
                }
            } catch (error) {
                console.error('Error joining cart:', error);
                const errorMsg = error.response?.data?.message || error.message || 'Failed to join cart';
                showToast(errorMsg, 'error');
            }
        }

        function stopSharing() {
            if (confirm('Stop sharing your cart? You can share it again later.')) {
                localStorage.removeItem('myShoppingCart');
                mySharedCart = null;
                showToast('Cart sharing stopped', 'info');
                loadSharedCarts();
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('myShoppingCart');
            window.location.href = '../index.html';
        }

        // Initialize
        init();
    </script>
</body>
</html>
